<?php

/**
 * @file
 * Cookiebar module file.
 */

use Drupal\Core\Url;

// Globals.
$GLOBALS["cookie_name"] = 'CookieConsent';

/**
 * Implements hook_theme().
 */
function advanced_cookiebar_theme($existing, $type, $theme, $path) {
  // This defines the variables that will be useable in the templates.
  return [
    'advanced_cookiebar' => [
      'variables' => [
        'label' => NULL,
        'cookies' => NULL,
        'text' => NULL,
        'accept_button_text' => NULL,
        'decline_button_text' => NULL,
      ],
    ],
    'advanced_cookiebar_advanced' => [
      'variables' => [
        'label' => NULL,
        'cookies' => NULL,
        'text' => NULL,
        'accept_button_text' => NULL,
        'decline_button_text' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 */
function advanced_cookiebar_page_attachments(array &$attachments) {
  $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();
  if ($is_admin) {
    $attachments['#attached']['library'][] = 'advanced_cookiebar/cookiebar-css-admin';
    return;
  }
}

/**
 * Implements hook_preprocess().
 */
function advanced_cookiebar_preprocess(&$variables) {
  $variables['advanced_cookie_value'] = GetCookieValue();
}

/**
 * Implements hook_preprocess_html().
 */
function advanced_cookiebar_preprocess_html(&$variables) {
  $config = \Drupal::configFactory()->getEditable('advanced_cookiebar.settings');
  $cookiepage_path = $config->get('advanced_cookiebar.cookiepage_path');
  if (empty($cookiepage_path)) {
    $cookiepage_path = "/cookies";
    $config->set('advanced_cookiebar.cookiepage_path', $cookiepage_path);
    $config->save();
  }

  $current_language = Drupal::languageManager()->getCurrentLanguage();
  $default_lang = Drupal::languageManager()->getDefaultLanguage();
  $homeUrl = Url::fromRoute('<front>', [], ['language' => $current_language]);
  $currentUrl = Url::fromRoute('<current>', [], ['language' => $default_lang]);

  $variables['#attached']['drupalSettings']['cookiebarConfig'] = [
    'cookiepagePath' => $cookiepage_path,
    'homeUrl' => $homeUrl->toString(),
    'currentUrl' => $currentUrl->toString(),
  ];
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function advanced_cookiebar_menu_local_tasks_alter(&$data, $route_name) {
  $config = \Drupal::config('advanced_cookiebar.settings');
  $cookiebar_type = $config->get('advanced_cookiebar.cookiebar_type');

  if ($cookiebar_type === "0") {
    unset($data['tabs'][0]['advanced_cookiebar.config']);
  }
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function advanced_cookiebar_theme_suggestions_advanced_cookiebar(array $variables) : array {
  return ['advanced_cookiebar_default'];
}

/**
 * Implement helper function get_cookie_value()
 *
 * To get the value of the cookie set by this module.
 *
 * @return mixed
 *   Returns either the json encode cookie values.
 */
function get_cookie_value() {
  $cookie_value = \Drupal::request()->cookies->get($GLOBALS["cookie_name"]);

  if (is_json($cookie_value)) {
    // For (advanced) cookieblock.
    return json_decode($cookie_value, TRUE);
  }
  else {
    // For (deafult) cookiebar.
    return $cookie_value;
  }

  return FALSE;
}

/**
 * Implement helper function is_json().
 *
 * @param mixed $string
 *   String to check if it's JSON.
 *
 * @return bool
 *   Returns TRUE if JSON else FALSE.
 */
function is_json($string) : bool {
  return is_string($string) && is_array(json_decode($string, TRUE)) ? TRUE : FALSE;
}

/**
 * Add new options to configuration.
 */
function advanced_cookiebar_update_8001() {
  $config = \Drupal::configFactory()->getEditable('advanced_cookiebar.settings');

  $cookies['primary_cookies'] = [
    'label' => 'Primary Cookies',
    'desc' => "",
  ];
  $config->set('advanced_cookiebar.settings_cookies', $cookies);
  $config->set('advanced_cookiebar.cookiebar_type', '0');
  $config->set('advanced_cookiebar.cookiepage_path', '/cookies');

  $config->save(TRUE);
}
