<?php
use Drupal\block_content\Entity\BlockContent;
use Drupal\block\Entity\Block;
use Drupal\node\Entity\Node;

/**
 * Implement hook_theme()
 * This function tells each theme what variables they can use
 * Changes Require chache clear
 *
 * @param unknown $existing
 * @param unknown $type
 * @param unknown $theme
 * @param unknown $path
 * @return array
 */
function kees_cookiebar_theme($existing, $type, $theme, $path) {

    return [
        'kees_cookiebar' => [
            'variables' => [
                'isCookie' => null,
                'cookies' => null,
                'label' => null,
                'text' => null,
                'accept_button_text' => null,
                'decline_button_text' => null,
            ],
        ],
        'kees_radioblock' => [
            'variables' => [
                'cookieValue' => null,
            ],
        ],
        'kees_cookiesPage' => [
            'variables' => [
                'cookieValue' => null,
                'title' => null,
                'intro' => null,
                'text' => null,
                'accept_button_text' => null,
                'decline_button_text' => null,
            ],
        ],
    ];
}

/**
 * Implement hook_install()
 * Will Add a block to content of current theme when installing the plugin
 *
 * @return void
 */
function kees_cookiebar_install()
{
    // Add block to content on module install
    $cookiebarBlock = Block::create([
        'id' => 'kees_cookiebar_block',
        'plugin' => 'kees_cookiebar_block',
        'region' => 'content',
        'weight' => 99,
        'theme' => \Drupal::config('system.theme')->get('default'),
        'settings' => [
            'label' => 'KeesTM Cookiebar Block',
            'label_display' => false,
        ],
    ]);
    $cookiebarBlock->save();
}

/**
 * Implement hook_page_attachments
 *
 * This function will attach a stylesheet to all admin pages.
 *
 * @param array $attachments
 * @return void
 */
function kees_cookiebar_page_attachments(array &$attachments) {
    $is_admin = \Drupal::service('router.admin_context')->isAdminRoute();
    if ($is_admin) {
        $attachments['#attached']['library'][] = 'kees_cookiebar/cookiebar-css-admin';
        return;
    }
}

/**
 * Implement hook_preprocess
 * This preprocess will add a variable to all pages
 *
 * @param array $variables
 * @return void
 */
function kees_cookiebar_preprocess(&$variables)
{
    $cookies = \Drupal::request()->cookies->get('CookieConsent');
    if (!empty($cookies)) {
        $variables['kees_cookies'] = json_decode($cookies, true);
    }
}
